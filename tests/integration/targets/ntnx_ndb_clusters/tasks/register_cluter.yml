---
- debug:
    msg: Start testing ntnx_ndb_clusters

- name: Register Cluster with prisim_vlan
  ntnx_ndb_clusters:
      wait: true
      name: "{{cluter_info.name}}"
      desc: "{{cluter_info.desc}}"
      name_prefix: "{{cluter_info.name_prefix}}"
      cluster_ip: "{{cluter_info.cluster_ip}}"
      cluster_credentials:
        username: "{{cluter_info.cluster_credentials.username}}"
        password: "{{cluter_info.cluster_credentials.password}}"
      agent_network:
        dns_servers:
          - "{{cluter_info.agent_network.dns_servers[0]}}"
          - "{{cluter_info.agent_network.dns_servers[1]}}"
        ntp_servers:
          - "{{cluter_info.agent_network.ntp_servers[0]}}"
          - "{{cluter_info.agent_network.ntp_servers[1]}}"
          - "{{cluter_info.agent_network.ntp_servers[2]}}"
          - "{{cluter_info.agent_network.ntp_servers[3]}}"
      vlan_access:
        prism_vlan:
          vlan_name: "{{cluter_info.vlan_access.prism_vlan.vlan_name}}"
          vlan_type: "{{cluter_info.vlan_access.prism_vlan.vlan_type}}"
          static_ip: "{{cluter_info.vlan_access.prism_vlan.static_ip}}"
          gateway: "{{cluter_info.vlan_access.prism_vlan.gateway}}"
          subnet_mask: "{{cluter_info.vlan_access.prism_vlan.subnet_mask}}"
      storage_container: "{{cluter_info.storage_container}}"
  register: result
  ignore_errors: true

- name: check listing status
  assert:
    that:
      - result.response is defined
      - result.failed == false
      - result.changed == true
      - result.response.name == "{{cluter_info.name}}"
      - result.response.description == "{{cluter_info.desc}}"
      - result.response.ipAddresses[0] == "{{cluter_info.cluster_ip}}"
    fail_msg: "fail: Unable to Register Cluster with prisim_vlan"
    success_msg: "pass: Register Cluster with prisim_vlan finished successfully"
######################################
- name: update cluster name , desc
  ntnx_ndb_clusters:
      uuid:  "{{result.cluster_uuid}}"
      name: newname
      desc: newdesc
  register: result
  ignore_errors: true

- name: check listing status
  assert:
    that:
      - result.response.name == "newname"
      - result.response.description == "newdesc"
    fail_msg: "fail: Unable to update cluster name , desc"
    success_msg: "pass: update cluster name , desc finished successfully"

######################################

- name: Negative Secnarios update storage container
  ntnx_ndb_clusters:
      uuid:  "{{result.cluster_uuid}}"
      storage_container: "{{cluter_info.storage_container}}"
  register: out
  ignore_errors: true

- name: check listing status
  assert:
    that:
      - out.changed == false
      - out.failed == true
      - out.msg == "parameters are mutually exclusive: uuid|storage_container"
    fail_msg: "Fail: storage_continer updated "
    success_msg: " Success: returned error as expected "

######################################

- name: Negative Secnarios update vlan access
  ntnx_ndb_clusters:
      uuid:  "{{result.cluster_uuid}}"
      vlan_access:
        prism_vlan:
          vlan_name: "{{cluter_info.vlan_access.prism_vlan.vlan_name}}"
          vlan_type: "{{cluter_info.vlan_access.prism_vlan.vlan_type}}"
          static_ip: "{{cluter_info.vlan_access.prism_vlan.static_ip}}"
          gateway: "{{cluter_info.vlan_access.prism_vlan.gateway}}"
          subnet_mask: "{{cluter_info.vlan_access.prism_vlan.subnet_mask}}"
  register: out
  ignore_errors: true

- name: check listing status
  assert:
    that:
      - out.changed == false
      - out.failed == true
      - out.msg == "parameters are mutually exclusive: uuid|vlan_access"
    fail_msg: "Fail: vlan_access updated "
    success_msg: " Success: returned error as expected "

######################################

- name: Negative Secnarios update agent network
  ntnx_ndb_clusters:
      uuid:  "{{result.cluster_uuid}}"
      agent_network:
        dns_servers:
          - "{{cluter_info.agent_network.dns_servers[0]}}"
          - "{{cluter_info.agent_network.dns_servers[1]}}"
        ntp_servers:
          - "{{cluter_info.agent_network.ntp_servers[0]}}"
          - "{{cluter_info.agent_network.ntp_servers[1]}}"
          - "{{cluter_info.agent_network.ntp_servers[2]}}"
          - "{{cluter_info.agent_network.ntp_servers[3]}}"
  register: out
  ignore_errors: true

- name: check listing status
  assert:
    that:
      - out.changed == false
      - out.failed == true
      - out.msg == "parameters are mutually exclusive: uuid|agent_network"
    fail_msg: "Fail: agent_network updated "
    success_msg: " Success: returned error as expected "

######################################

- name: Negative Secnarios update agent network
  ntnx_ndb_clusters:
      uuid:  "{{result.cluster_uuid}}"
      name_prefix: "{{cluter_info.name_prefix}}"
  register: out
  ignore_errors: true

- name: check listing status
  assert:
    that:
      - out.changed == false
      - out.failed == true
      - out.msg == "parameters are mutually exclusive: uuid|name_prefix"
    fail_msg: "Fail: name_prefix updated "
    success_msg: " Success: returned error as expected "

######################################
- name: delete cluster
  ntnx_ndb_clusters:
      uuid:    "{{result.cluster_uuid}}"
      state: absent
  register: result
  ignore_errors: true

- name: assert when status not complete
  assert:
    that:
      - result.response is defined
      - result.changed == true
      - result.failed == false
      - result.response.status == "DELETED"
    fail_msg: "Unable to delete custer"
    success_msg: "cluster  deleted successfully"


