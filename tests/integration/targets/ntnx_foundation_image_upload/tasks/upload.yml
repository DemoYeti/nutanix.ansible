---
- debug:
    msg: start testing ntnx_foundation_image_upload

- name: Download image for test
  get_url:
    url: "{{ image_url }}"
    dest: "{{ source }}"

- name: Image upload with nos installer_type
  ntnx_foundation_image_upload:
    state: present
    source: "{{ source }}"
    filename: "integration-test-ntnx-package.tar.gz"
    installer_type: nos
    timeout: 1800
  register: result
  ignore_errors: true

- name: Creation Status
  assert:
    that:
      - result.response is defined
      - result.failed==false
      - result.changed==true
    fail_msg: " Fail : unable to upload image  with nos installer_type "
    success_msg: "Succes: upload image  with nos installer_type successfully "

- name: Delete Image with nos installer_type with check mode
  ntnx_foundation_image_upload:
    state: absent
    filename: "integration-test-ntnx-package.tar.gz"
    installer_type: nos
  register: output
  ignore_errors: true
  check_mode: true

- name: Creation Status
  assert:
    that:
      - output.failed == false
      - output.changed == false
      - output.msg =="Image with name:integration-test-ntnx-package.tar.gz will be deleted."
      - output.image_name == "integration-test-ntnx-package.tar.gz"
    fail_msg: "Image with nos installer_type been deleted successfully within check_mode"
    success_msg: "Returned As expected"

- name: Delete Image with nos installer_type
  ntnx_foundation_image_upload:
    state: absent
    filename: "integration-test-ntnx-package.tar.gz"
    installer_type: nos
  register: result
  ignore_errors: true

- name: Creation Status
  assert:
    that:
      - result.response.status_code == 200
      - result.failed==false
      - result.changed==true
    fail_msg: " Fail : unable to delete image  with nos installer_type "
    success_msg: "Succes: image  with nos installer_type deleted successfully "
